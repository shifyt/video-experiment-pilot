<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Video Experiment</title>

  <script src="https://unpkg.com/jspsych@8.2.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.3/css/jspsych.css" rel="stylesheet" />

  <style>
    body { text-align: center; }
    .choice-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 20px;
    }
    img {
      max-width: 350px;
      border: 2px solid #333;
    }
  </style>
</head>

<body></body>

<script>

// =======================
// CONFIGURATION
// =======================

// PUT your backend save URL here (e.g., Render endpoint)
const DATA_SAVE_URL = "";

// PUT your Prolific completion link here
const PROLIFIC_COMPLETION_URL = "";

// =======================
// Capture Prolific IDs
// =======================

const urlParams = new URLSearchParams(window.location.search);
const PROLIFIC_PID = urlParams.get('PROLIFIC_PID');
const STUDY_ID = urlParams.get('STUDY_ID');
const SESSION_ID = urlParams.get('SESSION_ID');


// =======================
// Initialize jsPsych
// =======================

const jsPsych = initJsPsych({
  on_finish: function() {

    // Attach Prolific IDs to dataset
    jsPsych.data.addProperties({
      prolific_pid: PROLIFIC_PID,
      study_id: STUDY_ID,
      session_id: SESSION_ID
    });

    const csv = jsPsych.data.get().csv();

    // If backend is defined â†’ send to server
    if (DATA_SAVE_URL) {

      fetch(DATA_SAVE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/csv' },
        body: csv
      })
      .then(response => {
        if (!response.ok) throw new Error("Save failed");
        if (PROLIFIC_COMPLETION_URL) {
          window.location = PROLIFIC_COMPLETION_URL;
        }
      })
      .catch(err => {
        alert("Data saving failed. Please contact researcher.");
        console.error(err);
      });

    } else {

      // Fallback: download CSV locally (testing only)
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'experiment_data.csv';
      a.click();
    }
  }
});


// =======================
// Load Manifest
// =======================

let TRIAL_MANIFEST = [];

async function loadManifest() {
  const r = await fetch('trials/manifest.json');
  if (!r.ok) {
    alert("Could not load manifest.json");
    return;
  }
  TRIAL_MANIFEST = await r.json();
}


// =======================
// Trial Builder
// =======================

function buildTrial(trial) {

  const videoTrial = {
    type: jsPsychCallFunction,
    async: true,
    func: function(done) {
      document.body.innerHTML = "";

      const video = document.createElement("video");
      video.src = trial.video_url;
      video.width = 600;
      video.autoplay = true;
      video.controls = false;

      video.onended = () => done();
      video.onerror = () => {
        alert("Video failed to load: " + trial.video_url);
      };

      document.body.appendChild(video);
    }
  };

  const choiceTrial = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <p>What happens next? Press A or B.</p>
      <div class="choice-container">
        <div>
          <p><strong>A</strong></p>
          <img src="${trial.image_a_url}">
        </div>
        <div>
          <p><strong>B</strong></p>
          <img src="${trial.image_b_url}">
        </div>
      </div>
    `,
    choices: ['a','b'],
    data: {
      trial_id: trial.trial_id,
      correct_choice: trial.correct_choice
    },
    on_finish: function(data) {
      data.correct =
        (data.response === 'a' && trial.correct_choice === 'A') ||
        (data.response === 'b' && trial.correct_choice === 'B');
    }
  };

  return [videoTrial, choiceTrial];
}


// =======================
// Run Experiment
// =======================

async function run() {
  await loadManifest();

  let timeline = [];

  TRIAL_MANIFEST.forEach(trial => {
    timeline = timeline.concat(buildTrial(trial));
  });

  jsPsych.run(timeline);
}

run();

</script>

</html>
